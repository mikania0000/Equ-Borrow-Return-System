<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é³³ç”²åœ‹ä¸­è¨­å‚™ç®¡ç†ç³»çµ±</title>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
  <style>
    body {
      font-family: "è¯åº·ä¸­å„·é«”", sans-serif;
      text-align: center;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0px 20px 20px 20px;
    }
    .container {
      width: 90%;
      max-width: 1000px;
      margin-top: 10px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      font-size: 65px;
      font-weight: bold;
      text-align: center;
      background: linear-gradient(to right, #1E3A8A, #4A90E2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin-top: 0;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeIn 1.5s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      font-size: 40px;
      margin: 0;
    }
    .form-header {
      display: inline-block;
      padding: 8px 20px;
      border: 2px solid #FF8C00;
      border-radius: 80px;
      background: linear-gradient(to bottom, #FFD699, #FFB84D);
      box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
      font-weight: bold;
      margin-bottom: 20px;
    }

    .button-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      gap: 15px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .form-section {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .form-section.active {
      display: block;
    }

    /* ==========================================
       âœ… çµ±ä¸€è¡¨å–®æ’ç‰ˆ (Flexbox ç½®ä¸­å°é½Š)
       ========================================== */
    .form-group {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      width: 100%;
    }
    .form-group label {
      width: 150px; /* å›ºå®šæ¨™ç±¤å¯¬åº¦ï¼Œç¢ºä¿æ‰€æœ‰è¼¸å…¥æ¡†å·¦å´å°é½Š */
      font-size: 28px;
      text-align: right;
      margin-right: 20px;
      flex-shrink: 0;
    }
    .form-group .field-wrapper {
      width: 380px; /* çµ±ä¸€æ‰€æœ‰è¼¸å…¥æ¡†å®¹å™¨å¯¬åº¦ */
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
    }
    .form-group .field-wrapper input[type="text"],
    .form-group .field-wrapper select {
      flex: 1; /* å¡«æ»¿å®¹å™¨å¯¬åº¦ */
      width: 100%;
      height: 52px;
      font-size: 26px;
      padding: 8px 12px;
      border: 2px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .form-group .field-wrapper input::placeholder {
      font-size: 24px;
      color: #888;
      opacity: 1;
    }

    /* ==========================================
       âœ… Awesomplete è‡ªå‹•å®Œæˆå¥—ä»¶ä¿®æ­£ (å¼·åˆ¶å¸é™„è¼¸å…¥æ¡†)
       ========================================== */
    .awesomplete {
      display: block !important;
      width: 100% !important;
      flex: 1;
      position: relative; /* ç¢ºä¿ä¸‹æ‹‰æ¸…å–®ä»¥è¼¸å…¥æ¡†ç‚ºå°é½ŠåŸºæº– */
    }
    .awesomplete > ul {
      position: absolute !important;
      left: 0 !important;
      top: 100% !important; /* ç·Šè²¼åœ¨è¼¸å…¥æ¡†æ­£ä¸‹æ–¹ */
      margin-top: 4px !important;
      z-index: 99999 !important;
      width: 100% !important; /* å’Œè¼¸å…¥æ¡†ä¸€æ¨£å¯¬ */
      max-height: 350px !important;
      overflow-y: auto !important;
      font-size: 26px !important;
      background: white !important;
      border: 1px solid #ccc !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
    }
    .awesomplete > ul > li {
      padding: 10px 15px !important;
    }
    
    /* æƒææŒ‰éˆ•å°ˆå±¬æ¨£å¼ */
    .btn-scan-small {
      background-color: yellow;
      color: black;
      width: 120px;
      height: 52px;
      font-size: 18px;
      font-weight: bold;
      border: 2px solid #ccc;
      border-radius: 8px;
      flex-shrink: 0;
      padding: 0;
      cursor: pointer;
    }

    .button-group {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
    }
    .button-group button {
      width: 140px;
      padding: 10px;
    }

    button {
      padding: 10px 22px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 28px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    .btn-borrow { background-color: #32CD32; }
    .btn-return { background-color: #00BFFF; }
    .btn-repair { background-color: #FF4500; }
    .btn-query  { background-color: #FFEB3B; color: black; }
    .btn-new    { background-color: #FF8C00; }
    .btn-chalk  { background-color: #FF69B4; color: black; margin-left: auto; }
    .btn-cancel { background-color: #6c757d; }
    
    button:hover { opacity: 0.8; transform: scale(1.05); }
    button:active { opacity: 0.6; transform: scale(0.95); }
    a { text-decoration: none; }
    
    #borrow.form-section { background-color: #d4edda; }
    #return.form-section { background-color: #d1ecf1; }
    #repair.form-section { background-color: #f8d7da; }
    #new.form-section    { background-color: #f1e0d6; }
    #query.form-section  { background-color: #fff3cd; }
    #settings.form-section { background-color: #ffe0b2; }

    #borrow-result, #return-result, #new-result, #query-result {
      font-size: 30px !important;
      font-weight: bold;
      margin-top: 15px;
      width: 100%;
      word-wrap: break-word;
      white-space: normal;
      overflow: hidden;
      text-align: center;
    }

    .btn-red {
      background-color: #FF4D4D;
      color: white;
    }
    .btn-clear {
      background-color: yellow;
      color: black;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <h1>é³³ç”²åœ‹ä¸­è¨­å‚™ç®¡ç†ç³»çµ±</h1>
    <div class="button-container">
      <button class="btn-borrow" onclick="showForm('borrow')">å€Ÿç”¨</button>
      <button class="btn-return" onclick="showForm('return')">æ­¸é‚„</button>
      <button class="btn-new" onclick="showForm('new')">æ–°å¢</button>
      <button class="btn-query" onclick="showForm('query')">æŸ¥è©¢</button>
      <button class="btn-chalk" onclick="openChalkRegistration()">ç²‰ç­†æ¿æ“¦ç™»è¨˜</button>
      <button class="btn-settings" onclick="openAdvancedSettings()">é€²éšè¨­å®š</button>
    </div>
    
    <!-- ===================== å€Ÿç”¨è¨­å‚™ ===================== -->
    <div id="borrow" class="form-section">
      <div class="form-header">
        <h2>å€Ÿç”¨è¨­å‚™</h2>
      </div>

      <div class="form-group">
        <label for="borrow-identity">èº«åˆ†</label>
        <div class="field-wrapper">
          <select id="borrow-identity">
            <option value="æ•™å¸«" selected>æ•™å¸«</option>
            <option value="å­¸ç”Ÿ">å­¸ç”Ÿ</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="borrow-name">å§“å</label>
        <div class="field-wrapper">
          <input type="text" id="borrow-name" class="awesomplete" placeholder="ğŸ” é—œéµå­—æŸ¥è©¢" autocomplete="off">
        </div>
      </div>

      <div class="form-group">
        <label for="borrow-barcode">è¨­å‚™æ¢ç¢¼</label>
        <div class="field-wrapper">
          <input type="text" id="borrow-barcode" inputmode="numeric" placeholder="è«‹è¼¸å…¥è¨­å‚™æ¢ç¢¼">
          <button class="btn-scan-small" onclick="toggleScanner('borrow')">æ‰‹æ©Ÿæƒæç”¨</button>
        </div>
      </div>

      <div id="scanner-container-borrow" style="display:none; margin-top:10px;"></div>

      <div class="form-group">
        <label for="borrow-unit">å€Ÿç”¨å–®ä½</label>
        <div class="field-wrapper">
          <select id="borrow-unit">
            <option value="">è«‹é¸æ“‡å–®ä½</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="borrow-days">å€Ÿç”¨å¤©æ•¸</label>
        <div class="field-wrapper">
          <select id="borrow-days">
            <option value="1" selected>1å¤©</option>
            <option value="2">2å¤©</option>
            <option value="3">3å¤©</option>
            <option value="7">7å¤©</option>
            <option value="30">30å¤©</option>
            <option value="long">é•·å€Ÿ</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-borrow" onclick="submitBorrowForm()">ç¢ºå®šå€Ÿç”¨</button>
        <button class="btn-red" onclick="loadLastBorrowRecord()">é€£çºŒå€Ÿç”¨</button>
        <button class="btn-clear" onclick="resetBorrowForm()">æ¸…é™¤</button>
        <button class="btn-cancel" onclick="cancelForm('borrow')">é›¢é–‹</button>
      </div>
      <p id="borrow-result"></p>
    </div>

    <!-- ===================== æ­¸é‚„è¨­å‚™ ===================== -->
    <div id="return" class="form-section">
      <div class="form-header">
        <h2>æ­¸é‚„è¨­å‚™</h2>
      </div>

      <div class="form-group">
        <label for="return-barcode">è¨­å‚™æ¢ç¢¼</label>
        <div class="field-wrapper">
          <input type="text" id="return-barcode" inputmode="numeric" placeholder="è«‹è¼¸å…¥è¨­å‚™æ¢ç¢¼">
          <button class="btn-scan-small" onclick="toggleScanner('return')">æ‰‹æ©Ÿæƒæç”¨</button>
        </div>
      </div>

      <div id="scanner-container-return" style="display:none; margin-top:10px;"></div>

      <div class="button-group">
        <button class="btn-return" onclick="submitReturnForm()">ç¢ºå®šæ­¸é‚„</button>
        <button class="btn-cancel" onclick="cancelForm('return')">é›¢é–‹</button>
      </div>
      <p id="return-result"></p>
    </div>
      
    <!-- ===================== æ–°å¢æ•™å¸« ===================== -->
    <div id="new" class="form-section">
      <div class="form-header">
        <h2>æ–°å¢æ•™å¸«</h2>
      </div>

      <div class="form-group">
        <label for="new-teacher-name">æ•™å¸«å§“å</label>
        <div class="field-wrapper">
          <input type="text" id="new-teacher-name" placeholder="è«‹è¼¸å…¥æ•™å¸«å§“å">
        </div>
      </div>

      <div class="button-group">
        <button class="btn-new" onclick="submitNewTeacherForm()">ç¢ºå®šæ–°å¢</button> 
        <button class="btn-cancel" onclick="cancelForm('new')">é›¢é–‹</button>
      </div>
      <p id="new-result"></p>
    </div>

    <!-- ===================== æŸ¥è©¢è¨­å‚™ ===================== -->
    <div id="query" class="form-section">
      <div class="form-header">
        <h2>æŸ¥è©¢è¨­å‚™</h2>
      </div>

      <div class="form-group">
        <label for="query-class">ç­ç´š</label>
        <div class="field-wrapper">
          <input type="text" id="query-class" placeholder="è«‹è¼¸å…¥ç­ç´š">
        </div>
      </div>

      <div class="form-group">
        <label for="query-seat">åº§è™Ÿ</label>
        <div class="field-wrapper">
          <input type="text" id="query-seat" placeholder="è«‹è¼¸å…¥åº§è™Ÿ">
        </div>
      </div>

      <div class="form-group">
        <label for="query-name">å§“å</label>
        <div class="field-wrapper">
          <input type="text" id="query-name" placeholder="è«‹è¼¸å…¥å§“åé—œéµå­—">
        </div>
      </div>

      <div class="form-group">
        <label for="query-barcode">è¨­å‚™æ¢ç¢¼</label>
        <div class="field-wrapper">
          <input type="text" id="query-barcode" inputmode="numeric" placeholder="è«‹è¼¸å…¥æ¢ç¢¼:æ›´æ–°ç‹€æ…‹">
        </div>
      </div>

      <div class="form-group">
        <label for="query-equipment">è¨­å‚™åç¨±</label> 
        <div class="field-wrapper">
          <input type="text" id="query-equipment" placeholder="è«‹è¼¸å…¥è¨­å‚™é—œéµå­—">
        </div>
      </div>

      <div class="form-group">
        <label for="query-status">æ­¸é‚„æƒ…å½¢</label>
        <div class="field-wrapper">
          <select id="query-status">
            <option value=""></option> 
            <option value="æœªæ­¸é‚„">æœªæ­¸é‚„</option>
            <option value="å·²æ­¸é‚„">å·²æ­¸é‚„</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button id="query-button" class="btn-query btn-green" onclick="submitQueryForm()">æŸ¥è©¢</button>
        <button id="repair-button" class="btn-repair" onclick="submitRepairForm()">æ›´æ–°ç‹€æ…‹</button>
        <button id="clear-button" class="btn-clear btn-pink" onclick="resetQueryForm()">æ¸…é™¤</button>
        <button class="btn-cancel" onclick="cancelForm('query')">é›¢é–‹</button>
        <button id="identity-toggle-button" class="btn-identity-toggle" onclick="toggleIdentitySelection()">èº«åˆ†</button>
      </div>

      <p id="repair-result"></p>

      <div id="repair-options" style="display: none; margin-top: 30px; text-align: center;">
        <div style="display: block; margin: auto; background-color: #fffde7; border: 2px solid #fbc02d; border-radius: 16px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); padding: 30px 40px; max-width: 520px;">
          <form style="display: flex; flex-direction: column; align-items: center; gap: 25px;">
            <select id="repair-status-select" style="font-size: 28px; padding: 10px 20px; border-radius: 10px; width: 100%; max-width: 360px; border: 2px solid #ccc;">
              <option value="">è«‹é¸æ“‡è¨­å‚™ç‹€æ…‹</option>
              <option value="REPAIR">å ±ä¿®ï¼ˆç¶­ä¿®ä¸­ï¼‰</option>
              <option value="ENABLE">å•Ÿç”¨ï¼ˆå¯å€Ÿç”¨ï¼‰</option>
              <option value="UNASSIGNED">æœªç·¨ï¼ˆæœªç·¨è¨­å‚™ï¼‰</option>
            </select>

            <div style="display: flex; gap: 30px;">
              <button type="button" onclick="submitRepairStatusChange()" style="font-size: 28px; padding: 10px 24px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; min-width: 120px;">âœ… ç¢ºå®š</button>
              <button type="button" onclick="cancelRepairStatusChange()" style="font-size: 28px; padding: 10px 24px; background-color: #B0BEC5; color: black; border: none; border-radius: 8px; min-width: 120px;">âŒ å–æ¶ˆ</button>
            </div>
          </form>
        </div>
      </div>

      <p id="query-result" style="font-size: 30px; color: red; font-weight: bold;"></p>
      <div id="query-table-container"></div> 
    </div>

    <!-- ===================== é€²éšè¨­å®š ===================== -->
    <div id="settings" class="form-section">
      <div class="form-header">
        <h2>é€²éšè¨­å®š</h2>
      </div>

      <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px;">
        <button onclick="openInNewTab('https://script.google.com/a/macros/fjm.kh.edu.tw/s/AKfycbyC4Cd47_wv7-mVSgOLjKBa_kBrVw7R-ql49bZWNnvMGcZbQFCXuejeV7DQwnvsdyJV/exec')" style="width: 220px;background-color:#FF6B6B; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">å†·æ°£å„²å€¼HTML</button>
        <button onclick="openInNewTab('https://docs.google.com/spreadsheets/d/1_MfJZramhgQVdjWRqOjCWNKBW14P9yw4l9GFknl_iS8/edit?gid=1451666756')" style="width: 220px;background-color:#4DD0E1; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">è¨­å‚™å€Ÿç”¨ EXCEL</button>
        <button onclick="openInNewTab('https://script.google.com/a/macros/fjm.kh.edu.tw/s/AKfycbyReP2_g_Da25Qh2Bxa44b-awe3rpJWu258e7cko-is1yFdOFJ2YyUIeomOmVxocSbX/exec')" style="width: 220px;background-color:#81C784; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">è¨­å‚™è¨­å®šHTML</button>
        <button onclick="openInNewTab('https://docs.google.com/spreadsheets/d/16Btq6gd5j8ugpqFwRtQ-lpAgg9_Exn80UUrkhc4OYQE/edit?gid=578985482#gid=578985482')" style="width: 220px;background-color:#FFD54F; color:black; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">ç²‰ç­†æ¿æ“¦ EXCEL</button>
        <button onclick="openInNewTab('https://script.google.com/a/macros/fjm.kh.edu.tw/s/AKfycbwlC6kNYqplljKaQe6q9aamukFhLaVr2x-HTa3IOwINunxjK0RnDZ2bJHOwq-NeXQPJYA/exec')" style="width: 220px;background-color:#BA68C8; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">æœŸæœ«æ­¸é‚„ HTML</button>
        <button onclick="openInNewTab('https://docs.google.com/spreadsheets/d/1PQg7L9igcyy584fekpseDQZ75KnXwsby0FaEyQaiX5o/edit?gid=0#gid=0')" style="width: 220px;background-color:#F06292; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">è¨­å‚™ç¶­ä¿® EXCEL</button>
        <button onclick="openInNewTab('https://script.google.com/a/macros/fjm.kh.edu.tw/s/AKfycbwJJ2_4S8SjcgydQxMqiHBwACNFFVblbXsFQ7Fq84bD6st8BjnBIDZHiJowBrN2MIB9/exec')" style="width: 220px;background-color:#64B5F6; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">è¨­å‚™ç¶­ä¿® HTML</button>
        <button onclick="openInNewTab('https://script.google.com/a/macros/fjm.kh.edu.tw/s/AKfycbxBnPl_7XPedBwlk4pL3jYHwXteRd2SNegY24QLp6jGVvxCQDgRTXTu1XhF2rcaGh_mIw/exec')" style="width: 220px;background-color:#FF8A65; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">è¨­å‚™ç›¤é»</button>
        <button onclick="openInNewTab('')" style="width: 220px;background-color:#A1887F; color:white; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">é ç•™æŒ‰éˆ• 9</button>
        <button onclick="openInNewTab('')" style="width: 220px;background-color:#90CAF9; color:black; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">é ç•™æŒ‰éˆ• 10</button>
        <button onclick="openInNewTab('')" style="width: 220px;background-color:#AED581; color:black; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">é ç•™æŒ‰éˆ• 11</button>
        <button onclick="openInNewTab('')" style="width: 220px;background-color:#CE93D8; color:black; font-size:22px; padding:14px 20px; border:none; border-radius:10px;">é ç•™æŒ‰éˆ• 12</button>
      </div>

      <div class="button-group" style="display: flex; justify-content: center; margin-top: 30px;">
        <button class="btn-settings-cancel" onclick="cancelForm('settings')">é›¢é–‹</button>
      </div>
      <p id="settings-result"></p>
    </div>

  </div> <!-- âœ… é€™è£¡æ­£ç¢ºé–‰åˆäº† .container æ¨™ç±¤ï¼ -->

  <!-- ===================== æµ®å‹•å°è©±æ¡†å€ ===================== -->
  <div id="password-dialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.3); text-align:center; z-index:9999;">
    <p style="font-size:24px; font-weight:bold;">è«‹è¼¸å…¥å¯†ç¢¼</p>
    <input id="password-input" type="password" style="font-size:24px; padding:10px; width:80%; border:1px solid #ccc; border-radius:5px;"><br><br>
    <button onclick="verifyPassword()" style="font-size:20px; padding:8px 16px; background-color:#4CAF50; color:white; border:none; border-radius:5px;">ç¢ºèª</button>
    <button onclick="closePasswordDialog()" style="font-size:20px; padding:8px 16px; margin-left:10px; background-color:#ccc; color:black; border:none; border-radius:5px;">å–æ¶ˆ</button>
    <p id="password-error" style="color:red; font-size:18px; display:none; margin-top:10px;">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼</p>
  </div>

  <div id="delete-confirm-dialog" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.15); padding:32px 24px; z-index:9999; text-align:center;">
    <div style="font-size:28px; color:#d32f2f; margin-bottom:16px;">âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤è¨­å‚™ç´€éŒ„å—ï¼Ÿ</div>
    <button id="delete-confirm-btn" style="font-size:22px; background:#ff4081; color:#fff; border:none; border-radius:6px; padding:8px 32px; margin:0 12px;">ç¢ºå®š</button>
    <button id="delete-cancel-btn" style="font-size:22px; background:#ccc; color:#333; border:none; border-radius:6px; padding:8px 32px; margin:0 12px;">å–æ¶ˆ</button>
  </div>

<script>
// ==========================================
// ğŸš€ API é€£ç·šè¨­å®š
// ==========================================
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyRjMxPiPPPk3uGmVbSe2n7lwIsq3o0KfhU9LwS1Jz2KE8qF9rjpDzMiFmaUxoYuH1J/exec";

// å…±ç”¨ API å‘¼å«å‡½å¼
function callGasApi(action, params = {}) {
  return fetch(GAS_API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'text/plain;charset=utf-8',
    },
    body: JSON.stringify({ action: action, ...params })
  }).then(res => res.json());
}


let fullNameList = [];
let currentList = [];
let borrowNameInput = null;

document.addEventListener("DOMContentLoaded", function() {
  loadBorrowUnits();
  loadNameList();

  document.getElementById("borrow-identity").addEventListener("change", loadNameList);

  borrowNameInput = document.getElementById("borrow-name");
  if (borrowNameInput) {
    borrowNameInput.addEventListener("input", filterNameList);

    borrowNameInput._awesomplete = new Awesomplete(borrowNameInput, {
      minChars: 0,
      maxItems: 30,
      autoFirst: true,
      list: [],
      sort: false,
    });

    // â›” å·²åˆªé™¤åŸæœ¬åœ¨é€™è£¡è¦†è“‹é•·å¯¬çš„ç¡¬ä»£ç¢¼ï¼Œäº¤ç”± CSS æ§åˆ¶

    borrowNameInput.addEventListener("focus", function() {
      let current = borrowNameInput.value.trim().toLowerCase();
      currentList = current === "" ? fullNameList : fullNameList.filter(name => name.toLowerCase().includes(current));
      updateNameList(currentList);
      borrowNameInput._awesomplete.evaluate();
    });

    borrowNameInput.addEventListener("awesomplete-selectcomplete", function(e) {
      borrowNameInput.value = e.text.value;
    });
  }
});

function loadNameList() {
  let identity = document.getElementById("borrow-identity").value;
  callGasApi("getNameList", { identity }).then(function(names) {
    fullNameList = names || [];
    currentList = fullNameList;
    updateNameList(fullNameList);
  }).catch(e => console.error("Error loading name list:", e));
}

function filterNameList() {
  let input = borrowNameInput.value.trim().toLowerCase();
  currentList = input === "" ? fullNameList : fullNameList.filter(name => name.toLowerCase().includes(input));
  updateNameList(currentList);
}

function updateNameList(names) {
  if (borrowNameInput && borrowNameInput._awesomplete) {
    borrowNameInput._awesomplete.list = names.slice(0, 30);
  }
}

function searchStudentByName(name) {
  callGasApi("getStudentInfoByName", { name }).then(function (data) {
    if (data.length === 0) {
      alert("æŸ¥ç„¡æ­¤å­¸ç”Ÿ");
    } else if (data.length === 1) {
      fillStudentData(data[0]);
    } else {
      showStudentSelectionDialog(data);
    }
  }).catch(e => console.error(e));
}

function showStudentSelectionDialog(students, callback) {
  let dialogHtml = "<div id='studentDialogBox' style='text-align:left; font-size:18px;'>";
  dialogHtml += "<p><strong>è«‹é¸æ“‡æ­£ç¢ºçš„å­¸ç”Ÿï¼š</strong></p>";

  students.forEach((student, index) => {
    let studentData = JSON.stringify(student).replace(/"/g, '&quot;');
    dialogHtml += `
      <input type="radio" name="studentSelection" id="student${index}" value='${studentData}'>
      <label for="student${index}">${student.class}ç­ ${student.seat}è™Ÿ ${student.name}</label><br>
    `;
  });

  dialogHtml += `
    <br>
    <button onclick="selectStudent()" 
      style="padding: 10px 16px; font-size:16px; background-color: #32CD32; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
      ç¢ºå®š
    </button>
  </div>`;

  let dialog = document.createElement("div");
  dialog.id = "studentDialog";
  dialog.style.position = "fixed";
  dialog.style.top = "50%";
  dialog.style.left = "50%";
  dialog.style.transform = "translate(-50%, -50%)";
  dialog.style.backgroundColor = "white";
  dialog.style.padding = "20px";
  dialog.style.border = "2px solid #ccc";
  dialog.style.boxShadow = "0px 0px 10px rgba(0,0,0,0.5)";
  dialog.innerHTML = dialogHtml;

  document.body.appendChild(dialog);

  if(callback) window.studentSelectionCallback = callback;
}

function fillStudentData(student) {
  document.getElementById("borrow-name").value = student.name;
}

function loadBorrowUnits() {
  callGasApi("getBorrowUnits").then(function(units) {
    let select = document.getElementById("borrow-unit");
    select.innerHTML = '<option value="">è«‹é¸æ“‡å–®ä½</option>'; 
    units.forEach(function(unit) {
      let option = document.createElement("option");
      option.value = unit;
      option.textContent = unit;
      select.appendChild(option);
    });
  }).catch(e => console.error(e));
}

function clearInputAfterMessage(inputElem, timeoutMs = 3000, focusBack = true) {
  if (!inputElem) return;
  setTimeout(() => {
    inputElem.value = "";
    if (focusBack) {
      inputElem.focus();
      inputElem.select();
    }
  }, timeoutMs + 50);
}


function submitBorrowForm() {
  let identity = document.getElementById("borrow-identity").value;
  let name = document.getElementById("borrow-name").value.trim();
  let barcode = document.getElementById("borrow-barcode").value.trim();
  let unit = document.getElementById("borrow-unit").value;
  let days = document.getElementById("borrow-days").value;

  if (!name || !barcode || !unit || !days) {
    showFloatingMessage("è«‹å¡«å¯«å®Œæ•´è³‡æ–™", "error", 2500);
    return;
  }

  if (/^[A-Za-z]/.test(barcode)) {
    const barcodeInput = document.getElementById("borrow-barcode");
    showFloatingMessage("æ¢ç¢¼ç•°å¸¸ï¼Œè«‹æ”¹éµç›¤è¼¸å…¥", "warn", 3000);
    clearInputAfterMessage(barcodeInput, 3000, true);
    return;
  }

  showProgressBar("borrow", "ğŸ“¡ å€Ÿç”¨è™•ç†ä¸­...", function () {
    callGasApi("borrowEquipment", { identity, name, barcode, unit, days })
      .then(function (response) {
        let timeout = 2200;
        let type = "error";
        let msg = "";

        if (typeof response === "object" && response.message) {
          msg = response.message;
          if (response.status === "success") {
            type = "success";
            timeout = 1500;
            resetBorrowForm();
          } else if (response.status === "error") {
            type = "error";
            timeout = 3000;
          }
          showFloatingMessage(msg, type, timeout);
        } else {
          msg = response;
          let isSuccess = typeof response === "string" && response.includes("âœ…");
          type = isSuccess ? "success" : "error";
          timeout = isSuccess ? 1500 : 3000;
          showFloatingMessage(msg, type, timeout);
          if (isSuccess) resetBorrowForm();
        }

        const barElem = document.getElementById("borrow-progress-bar");
        if (barElem) barElem.parentElement.parentElement.innerHTML = "";
      }).catch(e => console.error(e));
  });
}

let inactivityTimer = null;

function startInactivityTimer(formId) {
  clearTimeout(inactivityTimer); 
  inactivityTimer = setTimeout(() => {
    showIdleWarning(formId); 
  }, 120000); 
}

function monitorUserActivity(formId) {
  const formElem = document.getElementById(formId);
  if (!formElem) return;

  ["mousemove", "keypress", "click", "input", "touchstart"].forEach(event => {
    formElem.addEventListener(event, () => startInactivityTimer(formId));
  });
  startInactivityTimer(formId);
}

function showIdleWarning(formId) {
  const activeSection = document.querySelector(".form-section.active");
  if (!activeSection) {
    return;
  }

  const msg = document.createElement("div");
  msg.innerText = "âš ï¸ 15 ç§’å¾Œå°‡è¿”å›ä¸»ç•«é¢";
  msg.style.position = "fixed";
  msg.style.top = "50%";
  msg.style.left = "50%";
  msg.style.transform = "translate(-50%, -50%)";
  msg.style.backgroundColor = "#f44336";
  msg.style.color = "white";
  msg.style.padding = "20px 40px";
  msg.style.fontSize = "32px";
  msg.style.fontWeight = "bold";
  msg.style.borderRadius = "12px";
  msg.style.zIndex = 9999;
  msg.style.opacity = 1;
  msg.style.transition = "opacity 1s ease-out";

  document.body.appendChild(msg);

  setTimeout(() => {
    msg.style.opacity = 0;
    setTimeout(() => msg.remove(), 1000);
  }, 3000);

  setTimeout(() => {
    cancelForm(formId);
  }, 15000);
}

function resetBorrowForm() {
  document.getElementById("borrow-identity").value = "æ•™å¸«"; 
  document.getElementById("borrow-name").value = ""; 
  document.getElementById("borrow-barcode").value = ""; 
  document.getElementById("borrow-unit").value = ""; 
  document.getElementById("borrow-days").value = "1"; 

  loadNameList();
  if (borrowNameInput && borrowNameInput._awesomplete) {
    borrowNameInput._awesomplete.list = [];
  }
}

function getStudentInfo(name, callback) {
  callGasApi("getStudentInfoByName", { name }).then(function(data) {
    if (data.length === 0) {
      callback(null); 
    } else if (data.length === 1) {
      callback(data[0]); 
    } else {
      showStudentSelectionDialog(data, callback);
    }
  });
}

function selectStudent() {
  let selectedStudent = document.querySelector('input[name="studentSelection"]:checked');
  if (selectedStudent) {
    let studentData = JSON.parse(selectedStudent.value);
    document.getElementById("borrow-name").value = studentData.name;
    window.selectedStudentInfo = {
      class: studentData.class || "",
      seat: studentData.seat || "",
      studentID: studentData.studentID || ""
    };

    let dialog = document.getElementById("studentDialog");
    if (dialog) dialog.remove();
  } else {
    showFloatingMessage("è«‹é¸æ“‡ä¸€ä½å­¸ç”Ÿï¼", "warn", 3000);
  }
}

function convertDays(days) {
  const dayMapping = { "1": 1, "2": 2, "3": 3, "7": 7, "30": 30, "long": 4000 };
  return dayMapping[days] || 0;
}

function loadLastBorrowRecord() {
  showProgressBar("borrow", "ğŸ“¡ å–å¾—ä¸Šæ¬¡å€Ÿç”¨ç´€éŒ„...", function () {
    callGasApi("getLastBorrowRecord").then(function(record) {
      const barElem = document.getElementById("borrow-progress-bar");
      if (barElem) barElem.parentElement.parentElement.innerHTML = "";

      if (!record || !record.name) {
       showFloatingMessage("âŒ æ‰¾ä¸åˆ°æœ€è¿‘çš„å€Ÿç”¨è¨˜éŒ„ï¼", "error", 3000);
        return;
      }

      document.getElementById("borrow-name").value = record.name;
      document.getElementById("borrow-unit").value = record.unit;

      let identitySelect = document.getElementById("borrow-identity");
      identitySelect.value = (record.className === "949") ? "æ•™å¸«" : "å­¸ç”Ÿ";

      let dayMapping = {
        "1": "1å¤©", "2": "2å¤©", "3": "3å¤©", "7": "7å¤©", "30": "30å¤©", "4000": "é•·å€Ÿ"
      };
      let daysSelect = document.getElementById("borrow-days");
      let borrowDaysText = dayMapping[record.days] || "1å¤©";
      let found = false;
      for (let option of daysSelect.options) {
        if (option.textContent.trim() === borrowDaysText) {
          daysSelect.value = option.value;
          found = true;
          break;
        }
      }
      if (!found) daysSelect.value = "1å¤©";

      showFloatingMessage("å·²åŒ¯å…¥ï¼Œè«‹è¼¸å…¥è¨­å‚™æ¢ç¢¼ï¼", "info", 1000);

      const barcodeInput = document.getElementById("borrow-barcode");
      barcodeInput.value = "";
      barcodeInput.focus();
      barcodeInput.select();
    });
  });
}

function showForm(formId, fromPassword = false) {
  Object.keys(scanners).forEach(key => {
    if (scanners[key]) {
      scanners[key].stop().then(() => {
        scanners[key] = null;
        const container = document.getElementById(`scanner-container-${key}`);
        if (container) container.style.display = 'none';
      }).catch(err => console.error('æƒæå™¨é—œé–‰å¤±æ•—:', err));
    }
  });

  document.getElementById("password-dialog").style.display = "none";

  if (["new", "query", "settings"].includes(formId) && !fromPassword) {
    openPasswordDialog(formId);
    return;
  }

  window.passwordVerified = false;

  document.querySelectorAll('.form-section').forEach(section => {
    section.classList.remove('active');
    let messageElem = section.querySelector('p');
    if (messageElem) messageElem.innerText = '';
  });

  if (formId === "borrow") {
    resetBorrowForm();
    setTimeout(() => { document.getElementById("borrow-name")?.focus(); }, 200);
  } else if (formId === "return") {
    resetReturnForm();
    setTimeout(() => { document.getElementById("return-barcode")?.focus(); }, 200);
  } else if (formId === "new") {
    resetNewForm();
    setTimeout(() => { document.getElementById("new-teacher-name")?.focus(); }, 200);
  } else if (formId === "query") {
    resetQueryForm();
    setTimeout(() => { document.getElementById("query-name")?.focus(); }, 200);
  }

  monitorUserActivity(formId);

  const target = document.getElementById(formId);
  if (target) {
    target.classList.add("active");
  }
}

function cancelForm(formId) {
  document.getElementById(formId).classList.remove('active');

  let inputs = document.querySelectorAll(`#${formId} input, #${formId} select`);
  inputs.forEach(input => {
    input.value = "";
  });

  if (formId === "borrow") {
    document.getElementById("borrow-identity").value = "æ•™å¸«"; 
    document.getElementById("borrow-days").value = "1"; 
    if (borrowNameInput && borrowNameInput._awesomplete) {
      borrowNameInput._awesomplete.list = [];
    }
  }

  let resultElem = document.getElementById(`${formId}-result`);
  if (resultElem) {
    resultElem.innerText = "";
  }
}

function openChalkRegistration() {
   document.getElementById("password-dialog").style.display = "none";
      var newWindow = window.open("https://mikania0000.github.io/FJM-CHALK/", "_blank");
      setTimeout(function() {
        if(newWindow && !newWindow.closed) {
          newWindow.close();
        }
      }, 120000);
    }

function openAdvancedSettings() {
  document.getElementById("password-dialog").style.display = "none";
  showForm("settings"); 
}

function submitReturnForm() {
  var barcodeInput = document.getElementById("return-barcode");
  var resultElem = document.getElementById("return-result");

  if (!barcodeInput) return;
  if (!resultElem) {
    resultElem = document.createElement("p");
    resultElem.id = "return-result";
    document.getElementById("return").appendChild(resultElem);
  }

  var barcode = barcodeInput.value.trim();

  if (!barcode) {
    showFloatingMessage("è«‹è¼¸å…¥æ¢ç¢¼!", "warn", 3000);
    return;
  }

  if (/^[A-Za-z]/.test(barcode)) {
    showFloatingMessage("æ¢ç¢¼ç•°å¸¸ï¼Œè«‹æ”¹éµç›¤è¼¸å…¥", "warn", 3000);
    clearInputAfterMessage(barcodeInput, 3000, true);
    return;
  }

  showProgressBar("return", "ğŸ“¡ æ­¸é‚„è™•ç†ä¸­...", function () {
    callGasApi("returnEquipment", { barcode }).then(function (response) {
      if (typeof response === "object" && response.message) {
        let isSuccess = response.status === "success";
        barcodeInput.value = "";
        let timeout = isSuccess ? 4000 : 3000;
        showFloatingMessage(response.message, isSuccess ? "success" : "error", timeout);
        resultElem.innerText = ""; 
      } else {
        let isSuccess = typeof response === "string" && response.includes("âœ…");
        barcodeInput.value = "";
        showFloatingMessage(response, isSuccess ? "success" : "error", 3000);
        if (isSuccess) resultElem.innerText = "";
      }
    });
  });
}

function resetReturnForm() {
  document.getElementById("return-barcode").value = "";
}

function resetNewForm() {
  var newForm = document.getElementById("new");
  if (newForm) {
    document.getElementById("new-teacher-name").value = ""; 
  }
}

function submitNewTeacherForm() {
  var name = document.getElementById("new-teacher-name").value.trim();

  if (!name) {
    showFloatingMessage("è«‹è¼¸å…¥æ•™å¸«å§“åï¼", "warn", 3000);
    return;
  }

  showProgressBar("new", "ğŸ“¡ æ–°å¢æ•™å¸«ä¸­...", function () {
    callGasApi("addNewTeacher", { name }).then(function(response) {
      let type = (response.status === "success") ? "success" : "error";
      showFloatingMessage(response.message, type, 3000);
      if (response.status === "success") {
        document.getElementById("new-teacher-name").value = "";
      }
    });
  });
}


function submitQueryForm() {
  document.getElementById("query-result").innerText = "";
  document.getElementById("query-table-container").innerHTML = "";
  document.getElementById("repair-options").style.display = "none";
  document.getElementById("repair-status-select").value = "";
  document.getElementById("repair-result").innerHTML = "";

  const className = document.getElementById("query-class").value.trim();
  const seat = document.getElementById("query-seat").value.trim().replace(/^0+/, '');
  const name = document.getElementById("query-name").value.trim();
  const barcode = document.getElementById("query-barcode").value.trim().replace(/^0+/, '');
  const equipment = document.getElementById("query-equipment").value.trim();
  const status = document.getElementById("query-status").value;

  const resultElem = document.getElementById("query-result");
  const tableContainer = document.getElementById("query-table-container");

  if (!className && !seat && !name && !barcode && !equipment && !status) {
    showFloatingMessage("è«‹è¼¸å…¥æŸ¥è©¢æ¢ä»¶!", "warn", 2500);
    return; 
  }

  showProgressBar("query", "ğŸ“¡ æŸ¥è©¢ä¸­...", function () {
    callGasApi("queryEquipmentData", { className, seat, name, barcode, equipment, status }).then(function (response) {
      if (typeof response === "object" && response.status) {
        let type = response.status === "warn" ? "warn"
                 : response.status === "success" ? "success"
                 : response.status === "info" ? "info"
                 : "error";
        showFloatingMessage(response.message, type, 2500);
        tableContainer.innerHTML = "";
        return;
      }

      let table = `
        <table class="query-table">
          <thead>
            <tr>
              <th>ç­ç´š</th><th>åº§è™Ÿ</th><th>å§“å</th><th>è¨­å‚™æ¢ç¢¼</th>
              <th>è¨­å‚™åç¨±</th><th>å€Ÿç”¨å–®ä½</th><th>å€Ÿç”¨æ™‚é–“</th>
              <th>æ­¸é‚„æ™‚é–“</th><th>æ­¸é‚„æƒ…å½¢</th><th>å€Ÿç”¨å¤©æ•¸</th><th>è™•ç†</th>
            </tr>
          </thead>
          <tbody>
      `;

      response.forEach(row => {
        const recordUUID = row[10];
        const borrowDaysRaw = String(row[9]).trim();
        const unit = row[5];

        table += `
          <tr id="row-${recordUUID}">
            <td style="text-align:center; vertical-align:middle;">${row[0]}</td>
            <td style="text-align:center; vertical-align:middle;">${row[1]}</td>
            <td style="text-align:center; vertical-align:middle;">${row[2]}</td>
            <td style="text-align:center; vertical-align:middle;">${row[3]}</td>
            <td style="text-align:center; vertical-align:middle;">${row[4]}</td>
            <td id="unit-cell-${recordUUID}" style="text-align:center; vertical-align:middle;">${unit}</td>
            <td style="text-align:center; vertical-align:middle;">${row[6]}</td>
            <td style="text-align:center; vertical-align:middle;">${row[7]}</td>
            <td style="text-align:center; vertical-align:middle;">${row[8]}</td>
            <td id="days-cell-${recordUUID}" style="text-align:center; vertical-align:middle;">${row[9]}</td>
            <td style="text-align:center; vertical-align:middle;">
              <div class="btn-container">
                <button id="modify-btn-${recordUUID}" class="btn-modify" 
                  onclick="enableEditMode('${recordUUID}', '${borrowDaysRaw}')">ä¿®æ”¹</button>
                <button class="btn-delete" onclick="deleteRecord('${recordUUID}')">åˆªé™¤</button>
                <button class="btn-cancel-edit" onclick="cancelEditMode('${recordUUID}', '${unit}', '${borrowDaysRaw}')">å–æ¶ˆ</button>
              </div>
            </td>
          </tr>
        `;
      });

      table += "</tbody></table>";
      tableContainer.innerHTML = table;
      resultElem.innerText = "";

      applyTableFormatting();
    });
  });
}

function enableEditMode(uuid, currentDays) {
  var cellDays = document.getElementById(`days-cell-${uuid}`);
  var cellUnit = document.getElementById(`unit-cell-${uuid}`);
  var modifyBtn = document.getElementById(`modify-btn-${uuid}`);

  if (!cellDays || !cellUnit || !modifyBtn) return;

  modifyBtn.innerText = "ç¢ºå®š";
  modifyBtn.classList.remove("btn-modify");
  modifyBtn.classList.add("btn-save-edit");
  modifyBtn.onclick = function () { saveEdit(uuid); };

  cellDays.innerHTML = `
    <select id="edit-days-${uuid}" class="edit-days-dropdown" style="font-size: 18px; padding: 5px 8px;">
      <option value="1" ${currentDays.includes("1") ? "selected" : ""}>1å¤©</option>
      <option value="2" ${currentDays.includes("2") ? "selected" : ""}>2å¤©</option>
      <option value="3" ${currentDays.includes("3") ? "selected" : ""}>3å¤©</option>
      <option value="7" ${currentDays.includes("7") ? "selected" : ""}>7å¤©</option>
      <option value="30" ${currentDays.includes("30") ? "selected" : ""}>30å¤©</option>
      <option value="4000" ${currentDays.includes("é•·å€Ÿ") ? "selected" : ""}>é•·å€Ÿ</option>
    </select>
  `;

  const currentUnit = cellUnit.innerText.trim();
  cellUnit.innerHTML = `<input id="edit-unit-${uuid}" value="${currentUnit}" style="width: 100px; font-size: 16px;">`;
}

function saveEdit(uuid) {
  var selectElem = document.getElementById(`edit-days-${uuid}`);
  var inputUnitElem = document.getElementById(`edit-unit-${uuid}`);
  var cellDays = document.getElementById(`days-cell-${uuid}`);
  var cellUnit = document.getElementById(`unit-cell-${uuid}`);
  var modifyBtn = document.getElementById(`modify-btn-${uuid}`);

  if (!selectElem || !inputUnitElem) {
    showFloatingMessage("âŒ é¸æ“‡æˆ–è¼¸å…¥çš„å€¼ç„¡æ•ˆï¼", "error",2000);
    return;
  }

  const newDays = selectElem.value;
  const newUnit = inputUnitElem.value.trim();

  if (!newUnit) {
    showFloatingMessage("è«‹è¼¸å…¥å€Ÿç”¨å–®ä½ï¼", "warn", 2500);
    return;
  }

  showFloatingMessage("ğŸ› ï¸ ä¿®æ”¹ä¸­è«‹ç¨å¾Œ...", "info");

  cellDays.innerText = newDays === "4000" ? "é•·å€Ÿ" : `${newDays}å¤©`;
  cellUnit.innerText = newUnit;

  modifyBtn.innerText = "ä¿®æ”¹";
  modifyBtn.classList.remove("btn-save-edit");
  modifyBtn.classList.add("btn-modify");
  modifyBtn.onclick = function () { enableEditMode(uuid, newDays); };

  callGasApi("updateBorrowDaysAndUnit", { uuid, newDays, newUnit }).then(function (response) {
    let type = (response.status === "success") ? "success" : "error";
    showFloatingMessage(response.message, type);
  });
}

function showFloatingMessage(message, type = "info", timeoutMs = null) {
  let existMsg = document.getElementById('floating-msg');
  if (existMsg) existMsg.remove();

  let emoji = "", bgColor = "", color = "#fff", fontSize = "26px", timeout = 3000;

  if (type === "success") {
    emoji = "âœ…"; bgColor = "#1e7c33"; timeout = 2000;
  } else if (type === "error") {
    emoji = "âŒ"; bgColor = "#d32f2f"; timeout = 3000; 
  } else if (type === "warn") {
    emoji = "âš ï¸"; bgColor = "#BF360C"; color = "#fff"; timeout = 3000; 
  } else if (type === "info") {
    emoji = "â„¹ï¸"; bgColor = "#1565c0"; timeout = 3000; 
  } else {
    emoji = ""; bgColor = "#333"; timeout = 2000;
  }

  if (typeof timeoutMs === "number") timeout = timeoutMs;

  let text = message.trim();
  if (emoji && text.startsWith(emoji)) text = text.replace(emoji, '').trim();

  const msg = document.createElement("div");
  msg.id = "floating-msg";
  msg.innerText = (emoji ? emoji + " " : "") + text;
  msg.style.position = "fixed";
  msg.style.top = "50%";
  msg.style.left = "50%";
  msg.style.transform = "translate(-50%, -50%)";
  msg.style.backgroundColor = bgColor;
  msg.style.color = color;
  msg.style.padding = "20px 20px";
  msg.style.fontSize = fontSize;
  msg.style.fontWeight = "bold";
  msg.style.borderRadius = "12px";
  msg.style.zIndex = 9999;
  msg.style.opacity = 1;
  msg.style.transition = "opacity 1s ease-out";
  msg.style.maxWidth = "90vw";
  msg.style.wordBreak = "break-all";
  msg.style.whiteSpace = "pre-line";
  msg.style.boxSizing = "border-box";

  document.body.appendChild(msg);

  setTimeout(() => {
    msg.style.opacity = 0;
    setTimeout(() => msg.remove(), 1000);
  }, timeout);
}

let pendingDeleteUUID = null;

function deleteRecord(uuid) {
  pendingDeleteUUID = uuid;
  document.getElementById('delete-confirm-dialog').style.display = "block";
}

document.getElementById('delete-confirm-btn').onclick = function() {
  if (!pendingDeleteUUID) return;
  document.getElementById('delete-confirm-dialog').style.display = "none";

  showFloatingMessage("è™•ç†ä¸­ï¼Œè«‹ç¨å¾Œ...", "info", 1200);

  callGasApi("deleteEquipmentRecord", { uuid: pendingDeleteUUID })
    .then(function(response) {
      let type = (response.status === "success" || response.status === "warning") ? "success" : "error";
      if (type === "success") {
        const row = document.getElementById(`row-${pendingDeleteUUID}`);
        if (row) row.remove();
      }

      let timeout = 2000; 
      if (response.status === "success") {
        timeout = 3000;      
      } else if (response.status === "warning") {
        timeout = 3000;      
      } else if (response.status === "error") {
        timeout = 3500;      
      }

      showFloatingMessage(response.message, type, timeout);
      pendingDeleteUUID = null;
    })
    .catch(function(error) {
      showFloatingMessage("âŒ åˆªé™¤å¤±æ•—ï¼š" + error.message, "error", 4000);
      pendingDeleteUUID = null;
    });
};

document.getElementById('delete-cancel-btn').onclick = function() {
  document.getElementById('delete-confirm-dialog').style.display = "none";
  pendingDeleteUUID = null;
};

function resetQueryForm() {
  document.getElementById("query-class").value = "";
  document.getElementById("query-seat").value = "";
  document.getElementById("query-name").value = "";
  document.getElementById("query-barcode").value = "";
  document.getElementById("query-equipment").value = "";
  document.getElementById("query-status").value = "";
  document.getElementById("query-result").innerText = "";
  document.getElementById("query-table-container").innerHTML = ""; 
  document.getElementById("repair-options").style.display = "none";
}

function submitRepairForm() {
  document.getElementById("query-result").innerText = "";
  document.getElementById("query-table-container").innerHTML = "";
  document.getElementById("repair-options").style.display = "none";
  document.getElementById("repair-status-select").value = "";
  document.getElementById("repair-result").innerHTML = "";

  const barcode = document.getElementById("query-barcode").value.trim();
  if (!barcode) {
    showFloatingMessage("è«‹å…ˆè¼¸å…¥è¨­å‚™æ¢ç¢¼ï¼", "warn");  
    return;
  }

  showProgressBar("repair", "ğŸ” è™•ç†ä¸­ï¼Œè«‹ç¨å€™...", () => {
    callGasApi("checkBarcodeStatus", { barcode }).then(function (response) {
      if (response.status === "NOT_FOUND") {
        showFloatingMessage("æ­¤è¨­å‚™æ¢ç¢¼ä¸å­˜åœ¨ï¼", "error");
      } else if (response.status === "BORROWED") {
        showFloatingMessage("æ­¤è¨­å‚™å€Ÿç”¨ä¸­ï¼Œè«‹å…ˆæ­¸é‚„ï¼", "error");
      } else if (response.status === "OK") {
        document.getElementById("repair-options").style.display = "flex";
        showCurrentDeviceStatus(response.currentStatus, response.equipmentName); 
      }
    });
  });
}

function showCurrentDeviceStatus(currentStatus, equipmentName) {
  const statusMap = {
    0: "å•Ÿç”¨ï¼ˆå¯å€Ÿç”¨ï¼‰",
    1: "å€Ÿå‡ºä¸­",
    2: "å ±ä¿®ï¼ˆç¶­ä¿®ä¸­ï¼‰",
    3: "æœªç·¨",
  };
  const statusText = statusMap[currentStatus] || "æœªçŸ¥ç‹€æ…‹";
  let container = document.getElementById("repair-options");
  if (!container) return;
  let exist = document.getElementById("current-status-info");
  if (exist) exist.remove();

  container.style.display = "flex";
  container.style.flexDirection = "column";
  container.style.alignItems = "center";

  let info = document.createElement("div");
  info.id = "current-status-info";
  info.style.fontSize = "28px";
  info.style.color = "#1E3A8A";
  info.style.marginBottom = "15px";
  info.style.fontWeight = "bold";
  info.style.textAlign = "center";
  info.style.width = "100%";
 info.innerHTML = `ç›®å‰${equipmentName ? `ã€${equipmentName}ã€‘` : ""}ï¼š<span style="color:#d32f2f;">${statusText}</span>`;

  container.prepend(info);
}

var isIdentityLocked = false; 

function toggleIdentitySelection() {
  var identitySelect = document.getElementById("borrow-identity");

  if (!identitySelect) return;

  if (identitySelect.disabled) {
    identitySelect.disabled = false;
    isIdentityLocked = false;
    showFloatingMessage("å€Ÿç”¨èº«åˆ†å¯ç‚ºæ•™å¸«æˆ–å­¸ç”Ÿ!", "success");
  } else {
    identitySelect.value = "æ•™å¸«";
    identitySelect.disabled = true;
    isIdentityLocked = true;
    showFloatingMessage(" å·²å›ºå®šå€Ÿç”¨èº«åˆ†ç‚ºæ•™å¸«!", "info");
  }
}

let scanners = {};

function toggleScanner(context) {
  const containerId = `scanner-container-${context}`;
  const inputId = context === 'borrow' ? 'borrow-barcode' : 'return-barcode';
  const container = document.getElementById(containerId);

  if (scanners[context]) {
    scanners[context].stop().then(() => {
      scanners[context] = null;
      container.innerHTML = "";
      container.style.display = 'none';
    }).catch(err => console.error('é—œé–‰å¤±æ•—', err));
  } else {
    container.innerHTML = "";
    container.style.display = 'block';

    const input = document.getElementById(inputId);
    if (input) input.value = "";

    scanners[context] = new Html5Qrcode(containerId);
    scanners[context].start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: 200, disableFlip: true }, 
      (decodedText) => {
        document.getElementById(inputId).value = decodedText;

        scanners[context].stop().then(() => {
          scanners[context] = null;
          container.innerHTML = "";
          container.style.display = 'none';
          if (context === 'return') submitReturnForm();
        }).catch(err => console.error('æƒæå™¨é—œé–‰å¤±æ•—:', err));
      },
      (errorMessage) => {}
    ).catch(err => {
      console.error('å•Ÿå‹•æƒæå™¨å¤±æ•—', err);
      container.style.display = 'none';
    });
  }
}

let pendingFormId = null;
window.passwordVerified = false;

function openPasswordDialog(formId) {
  document.querySelectorAll('.form-section').forEach(section => {
    section.classList.remove('active');
  });

  pendingFormId = formId;
  document.getElementById("password-dialog").style.display = "block";
  document.getElementById("password-input").value = "";
  document.getElementById("password-error").style.display = "none";
  document.getElementById("password-input").focus();

  const inputElem = document.getElementById("password-input");
  inputElem.onkeydown = function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); 
      verifyPassword();      
    }
  };
}

function verifyPassword() {
  const input = document.getElementById("password-input").value;
  if (input === "000000") {
    passwordVerified = true;
    closePasswordDialog();

    if (pendingFormId) {
      const target = pendingFormId;
      pendingFormId = null;
      setTimeout(() => {
        showForm(target, true);
      }, 100); 
    }
  } else {
    const errorElem = document.getElementById("password-error");
    errorElem.style.display = "block";
    setTimeout(function () {
      errorElem.style.display = "none";
    }, 2000);
  }
}

function closePasswordDialog() {
  document.getElementById("password-dialog").style.display = "none";
}

function cancelEditMode(uuid, originalUnit, originalDays) {
  const cellDays = document.getElementById(`days-cell-${uuid}`);
  const cellUnit = document.getElementById(`unit-cell-${uuid}`);
  const modifyBtn = document.getElementById(`modify-btn-${uuid}`);

  let daysValue = originalDays.replace("å¤©", "");
  let finalDaysText = daysValue === "4000" || originalDays === "é•·å€Ÿ" ? "é•·å€Ÿ" : `${daysValue}å¤©`;

  cellDays.innerText = finalDaysText;
  cellUnit.innerText = originalUnit;

  modifyBtn.innerText = "ä¿®æ”¹";
  modifyBtn.classList.remove("btn-save-edit");
  modifyBtn.classList.add("btn-modify");
  modifyBtn.onclick = function () {
    enableEditMode(uuid, daysValue);
  };
}

document.addEventListener("DOMContentLoaded", function() {
["scanner-container-borrow", "scanner-container-return"].forEach(id => {
  const container = document.getElementById(id);
  if (container) {
    container.style.width = "500px";
    container.style.height = "650px";
    container.style.margin = "auto";
    container.style.border = "2px solid #999";
    container.style.borderRadius = "10px";
    container.style.marginBottom = "60px";  
  }
});

  let identitySelect = document.getElementById("borrow-identity");
  if (identitySelect) {
    identitySelect.value = "æ•™å¸«";
    identitySelect.disabled = true; 
  }

  let queryBtn = document.getElementById("query-button");
  if (queryBtn) {
    queryBtn.style.backgroundColor = "#32CD32"; 
    queryBtn.style.color = "white";
  }

  let clearBtn = document.getElementById("clear-button");
  if (clearBtn) {
    clearBtn.style.backgroundColor = "#FF69B4"; 
    clearBtn.style.color = "white";
  }

  let identityToggleBtn = document.getElementById("identity-toggle-button");
  if (identityToggleBtn) {
    identityToggleBtn.style.backgroundColor = "#5D0092"; 
    identityToggleBtn.style.color = "white";
    identityToggleBtn.style.fontSize = "28px";
    identityToggleBtn.style.fontWeight = "bold";
    identityToggleBtn.style.padding = "12px 24px";
    identityToggleBtn.style.borderRadius = "8px";
    identityToggleBtn.style.cursor = "pointer";
    identityToggleBtn.style.boxShadow = "2px 2px 5px rgba(0, 0, 0, 0.2)";
  }

  let settingsButton = document.querySelector(".btn-settings");
  if (settingsButton) {
    settingsButton.style.backgroundColor = "#FF6347"; 
    settingsButton.style.color = "white";
    settingsButton.style.fontSize = "28px";
    settingsButton.style.padding = "10px 22px";
    settingsButton.style.borderRadius = "10px";
    settingsButton.style.boxShadow = "3px 3px 6px rgba(0, 0, 0, 0.4)";
  }

});

function applyTableFormatting() {
  let table = document.querySelector(".query-table");
  if (!table) return;

  table.style.width = "100%";
  table.style.borderCollapse = "collapse";

  let headers = table.querySelectorAll("thead th");
  headers.forEach(th => {
    th.style.backgroundColor = "#1E3A8A";
    th.style.color = "white";
    th.style.fontSize = "19px";
    th.style.textAlign = "center";
    th.style.padding = "12px";
    th.style.border = "1px solid white";
  });

  let cells = table.querySelectorAll("tbody td");
  cells.forEach(td => {
    td.style.backgroundColor = "#E3F2FD";
    td.style.padding = "10px";
    td.style.border = "1px solid #ccc";
    td.style.textAlign = "center";
    td.style.verticalAlign = "middle";
    td.style.fontSize = "18px";
  });

  let colWidths = ["6%", "6%", "12%", "8%", "14%", "10%", "12%", "8%", "9%", "10%", "15%"];
  let rows = table.querySelectorAll("tr");
  rows.forEach(row => {
    let cells = row.children;
    for (let i = 0; i < cells.length; i++) {
      if (colWidths[i]) cells[i].style.width = colWidths[i];
    }
  });

let buttons = table.querySelectorAll(".btn-modify, .btn-delete, .btn-save-edit, .btn-cancel-edit");
buttons.forEach(btn => {
  btn.style.width = "100px";
  btn.style.height = "40px";
  btn.style.fontSize = "18px";
  btn.style.border = "none";
  btn.style.borderRadius = "10px";
  btn.style.cursor = "pointer";
  btn.style.margin = "5px";
  btn.style.display = "inline-flex";
  btn.style.justifyContent = "center";
  btn.style.alignItems = "center";

  if (btn.classList.contains("btn-modify")) {
    btn.style.backgroundColor = "#FFD700"; 
    btn.style.color = "black";
  } else if (btn.classList.contains("btn-delete")) {
    btn.style.backgroundColor = "#B22222"; 
    btn.style.color = "white";
  } else if (btn.classList.contains("btn-save-edit")) {
    btn.style.backgroundColor = "#28a745"; 
    btn.style.color = "white";
  } else if (btn.classList.contains("btn-cancel-edit")) {
    btn.style.backgroundColor = "#FF69B4"; 
    btn.style.color = "white";
  }
});
}

document.addEventListener("DOMContentLoaded", function() {
  applyTableFormatting();
  let observer = new MutationObserver(applyTableFormatting);
  observer.observe(document.getElementById("query-table-container"), { childList: true, subtree: true });
});

function submitRepairStatusChange() {
  const barcode = document.getElementById("query-barcode").value.trim();
  const actionType = document.getElementById("repair-status-select").value;

  if (!barcode) {
    showFloatingMessage("è«‹è¼¸å…¥æ¢ç¢¼ï¼", "warn", 2500);
    return;
  }
  if (!actionType) {
    showFloatingMessage("è«‹é¸æ“‡è¨­å‚™ç‹€æ…‹ï¼", "warn", 2500);
    return;
  }

  let finalAction = actionType;
  if (actionType === "UNASSIGNED") {
    finalAction = "SET_TO_3"; 
  }

  showFloatingMessage("è™•ç†ä¸­ï¼Œè«‹ç¨å€™...", "info");

  callGasApi("processRepair", { barcode, actionType: finalAction }).then(function (response) {
    document.getElementById("repair-options").style.display = "none";
    document.getElementById("query-result").innerText = "";
    document.getElementById("query-table-container").innerHTML = "";

    if (typeof response === 'object' && response.status === "success") {
      showFloatingMessage(`${response.equipmentName} å·²æ›´æ–°ç‚º- ${response.newStatus}`, "success",3500);
    } else if (typeof response === 'object') {
      showFloatingMessage(response.message || "âŒ æ“ä½œå¤±æ•—", "error", 2000);
    } else {
      showFloatingMessage(response.includes("âœ…") ? response : "âŒ " + response, response.includes("âœ…") ? "success" : "error", 2000);
    }
  });
}

function cancelRepairStatusChange() {
  document.getElementById("repair-options").style.display = "none";
  document.getElementById("query-result").innerText = "";
  document.getElementById("query-table-container").innerHTML = "";
  document.getElementById("repair-status-select").value = "";
}

function showProgressBar(formId, message, callback) {
  const resultElem = document.getElementById(`${formId}-result`);
  if (!resultElem) return;

  resultElem.innerHTML = `
    <div style="font-size: 28px; font-weight: bold; color: #d63384;">${message}</div>
    <div style="width: 100%; background: #f8d7da; border-radius: 10px; margin-top: 10px;">
      <div id="${formId}-progress-bar"
           style="width: 0%; height: 28px; background: linear-gradient(to right, #FFB6C1, #FF69B4); border-radius: 10px;
                  text-align: center; color: white; font-weight: bold; font-size: 20px;">
      </div>
    </div>
  `;

  let progress = 0;
  let called = false;

  const interval = setInterval(() => {
    progress += Math.floor(Math.random() * 5 + 3);
    if (progress > 100) progress = 100;

    const bar = document.getElementById(`${formId}-progress-bar`);
    if (bar) {
      bar.style.width = `${progress}%`;
      bar.innerText = `${progress}%`;
    }

    if (!called && progress >= 1) {
      called = true;
      if (callback) callback();  
    }

    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        const parent = bar?.parentElement?.parentElement;
        if (parent) parent.innerHTML = "";
      }, 300);
    }
  }, 100); 
}

function openInNewTab(url) {
  if (!url) {
    alert("âš ï¸ å°šæœªè¨­å®šé€£çµï¼");
    return;
  }
  window.open(url, '_blank');
}

function monitorInputFormat(inputId, type, formId) {
  const inputElem = document.getElementById(inputId);
  if (!inputElem) return;

  let lastWarningTime = 0;
  let isComposing = false;
  let firstInputTime = 0;

  inputElem.addEventListener("compositionstart", () => { isComposing = true; });

  inputElem.addEventListener("compositionend", () => {
    isComposing = false;
    if (type === "barcode") checkBarcode();
    if (type === "name") checkName();
  });

  inputElem.addEventListener("input", () => {
    const now = Date.now();
    let val = inputElem.value;

    if (val.length >= 4) {
      if (firstInputTime === 0) firstInputTime = now;
      const duration = now - firstInputTime;

      if (duration < 300) {
        val = val.replace(/^\*+|\*+$/g, "").replace(/\s+/g, "");
        inputElem.value = val;
        return; 
      }
    } else {
      firstInputTime = 0; 
    }
  });

  function checkBarcode() {
    if (isComposing) return;
    const now = Date.now();
    let val = inputElem.value;
    val = val.replace(/^\*+|\*+$/g, "");
    inputElem.value = val;
    if (val !== "" && /[^a-zA-Z0-9]/.test(val)) {
      inputElem.value = "";
      if (now - lastWarningTime > 1000) {
        showFormMessage(formId, "âš ï¸ è«‹åˆ‡æ›ç‚º <è‹±æ–‡> è¼¸å…¥æ³•", "red", 28, 3000);
        lastWarningTime = now;
      }
    }
  }

  function checkName() {
    if (isComposing) return;
    const now = Date.now();
    const val = inputElem.value;
    if (val !== "" && /^[a-zA-Z0-9\s!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+$/.test(val) && val.length >= 3) {
      inputElem.value = "";
      if (now - lastWarningTime > 1000) {
        showFormMessage(formId, "âš ï¸ è«‹åˆ‡æ›ç‚º <ä¸­æ–‡> è¼¸å…¥æ³•", "red", 28, 3000);
        lastWarningTime = now;
      }
    }
  }

  if (type === "barcode") inputElem.addEventListener("input", checkBarcode);
  if (type === "name") inputElem.addEventListener("input", checkName);
}

document.addEventListener("DOMContentLoaded", () => {
  monitorInputFormat("borrow-barcode", "barcode", "borrow");
  monitorInputFormat("return-barcode", "barcode", "return"); 
  monitorInputFormat("query-barcode", "barcode", "query");
  monitorInputFormat("borrow-name", "name", "borrow");
  monitorInputFormat("query-name", "name", "query");

  const returnInput = document.getElementById("return-barcode");
  let firstInputTime = 0;
  let lastCharTime = 0;
  let lastValue = "";
  let isSubmitting = false;

  if (returnInput) {
    returnInput.addEventListener("input", () => {
      const now = Date.now();
      const val = returnInput.value.trim();

      if (val.length === 1 || val !== lastValue) {
        if (val.length === 1) firstInputTime = now;
        lastCharTime = now;
        lastValue = val;
      }

      const totalInputDuration = now - firstInputTime;
      const lastCharGap = now - lastCharTime;

      const isScanner = val.length >= 4 && totalInputDuration <= 400 && lastCharGap <= 300 && !isSubmitting;

      if (isScanner) {
        isSubmitting = true;
        setTimeout(() => {
          submitReturnForm();
          firstInputTime = 0;
          lastCharTime = 0;
          lastValue = "";
          isSubmitting = false;
        }, 100);
      }
    });

    returnInput.addEventListener("blur", () => {
      firstInputTime = 0;
      lastCharTime = 0;
      lastValue = "";
      isSubmitting = false;
    });
  }
});

// âœ… å·²åˆªé™¤å°è‡´åå–®ä½ç§»çš„èˆŠç‰ˆ JS å®šä½è¨ˆç®—
// å…¨éƒ¨äº¤çµ¦ CSS (left: 0, top: 100%) ä¾†å®Œç¾å¸é™„è¼¸å…¥æ¡†

function showFormMessage(formId, message, color, size, timeout) {
  const resultElem = document.getElementById(`${formId}-result`);
  if (!resultElem) return;

  resultElem.innerText = message;
  resultElem.style.color = color;
  resultElem.style.fontSize = size + "px";

  setTimeout(() => {
    resultElem.innerText = "";
  }, timeout);
}
</script>
</body>
</html>